// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// To swap between SQLite for local dev and PostgreSQL for production,
// you only need to change the two blocks below and run `npx prisma migrate dev`.

// Block for SQLite (local development)
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Block for PostgreSQL (NeonDB, Vercel Postgres, etc.)
// datasource db {
//   provider     = "postgresql"
//   url          = env("DATABASE_URL")
//   relationMode = "prisma"
// }

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  name                String
  avatarUrl           String?
  subscriptionStatus  String            @default("trial") // active, inactive, trial
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  vaults              VaultMember[]
  ownedAccounts       Account[]
  goals               Goal[]
  goalParticipations  GoalParticipant[]
  sentInvitations     Invitation[]      @relation("SentInvitations")
  receivedInvitations Invitation[]      @relation("ReceivedInvitations")
  notifications       Notification[]
  transactions        Transaction[]
}

model Vault {
  id        String        @id @default(cuid())
  name      String
  imageUrl  String?
  ownerId   String // ID of the user who owns the vault
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  members   VaultMember[]
  accounts  Account[]
  goals     Goal[]
  transactions Transaction[]
}

model VaultMember {
  id        String   @id @default(cuid())
  vaultId   String
  userId    String
  role      String // "owner" or "member"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vault     Vault    @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, vaultId])
}

model Account {
  id                   String        @id @default(cuid())
  name                 String
  bank                 String
  type                 String // "checking", "savings", "investment", "credit_card"
  balance              Float
  creditLimit          Float?
  logoUrl              String?
  scope                String // 'personal' ou um vaultId
  visibleIn            String? // Comma-separated vaultIds
  allowFullAccess      Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  ownerId              String
  owner                User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  vaultId              String?
  vault                Vault?        @relation(fields: [vaultId], references: [id], onDelete: SetNull)
  sourceTransactions   Transaction[] @relation("SourceTransactions")
  destTransactions     Transaction[] @relation("DestTransactions")
}

model Goal {
  id              String            @id @default(cuid())
  name            String
  targetAmount    Float
  currentAmount   Float             @default(0)
  emoji           String
  visibility      String            @default("shared") // "private" or "shared"
  isFeatured      Boolean           @default(false)
  ownerId         String // Can be a userId or vaultId
  ownerType       String // "user" or "vault"
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  userId          String?
  user            User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  vaultId         String?
  vault           Vault?            @relation(fields: [vaultId], references: [id], onDelete: SetNull)
  participants    GoalParticipant[]
  transactions    Transaction[]
}

model GoalParticipant {
  id                    String   @id @default(cuid())
  goalId                String
  userId                String
  role                  String // "owner" or "member"
  contributionContextId String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  goal                  Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, goalId])
}

model Transaction {
  id                   String    @id @default(cuid())
  date                 DateTime
  description          String
  amount               Float
  type                 String // "income", "expense", "transfer"
  category             String
  paymentMethod        String?
  isRecurring          Boolean   @default(false)
  isInstallment        Boolean   @default(false)
  installmentNumber    Int?
  totalInstallments    Int?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Actor who performed the transaction
  actorId              String
  actor                User      @relation(fields: [actorId], references: [id], onDelete: Restrict)

  // Transaction context: belongs to a user or a vault
  userId               String?
  user                 User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vaultId              String?
  vault                Vault?     @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  // Accounts involved
  sourceAccountId      String?
  sourceAccount        Account?  @relation("SourceTransactions", fields: [sourceAccountId], references: [id], onDelete: SetNull)
  destinationAccountId String?
  destinationAccount   Account?  @relation("DestTransactions", fields: [destinationAccountId], references: [id], onDelete: SetNull)

  // Goal involved (if any)
  goalId               String?
  goal                 Goal?     @relation(fields: [goalId], references: [id], onDelete: SetNull)
}


model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  text        String
  link        String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  actorId     String?
  actorName   String?
  actorAvatar String?
  relatedId   String?
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Invitation {
  id         String   @id @default(cuid())
  type       String // "vault" or "goal"
  targetId   String
  targetName String
  status     String   @default("pending") // "pending", "accepted", "declined"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  senderId   String
  sender     User     @relation("SentInvitations", fields: [senderId], references: [id], onDelete: Restrict)
  receiverId String
  receiver   User     @relation("ReceivedInvitations", fields: [receiverId], references: [id], onDelete: Restrict)

  @@unique([receiverId, targetId])
}

model SavedReport {
  id           String   @id @default(cuid())
  ownerId      String
  monthYear    String
  analysisHtml String
  createdAt    DateTime @default(now())

  @@unique([ownerId, monthYear])
}
