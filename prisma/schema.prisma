// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(cuid())
  email              String          @unique
  name               String
  avatarUrl          String?
  subscriptionStatus String          @default("active") // active, inactive, trial
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  accounts           Account[]
  goals              Goal[]
  vaultsOwned        Vault[]         @relation("VaultOwner")
  vaults             VaultMember[]
  transactions       Transaction[]   @relation("TransactionActor")
  invitationsSent    Invitation[]    @relation("InvitationSender")
  invitationsReceived Invitation[]  @relation("InvitationReceiver")
  notifications      Notification[]
  goalParticipations GoalParticipant[]

  @@map("users")
}

model Vault {
  id        String        @id @default(cuid())
  name      String
  imageUrl  String?
  ownerId   String
  owner     User          @relation("VaultOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members   VaultMember[]
  accounts  Account[]
  goals     Goal[]
  transactions Transaction[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("vaults")
}

model VaultMember {
  id      String @id @default(cuid())
  userId  String
  vaultId String
  role    String // "owner", "member", "admin"
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  vault   Vault  @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@unique([userId, vaultId])
  @@map("vault_members")
}

model Account {
  id                   String        @id @default(cuid())
  ownerId              String
  owner                User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  scope                String // 'personal' or vaultId
  vaultId              String?
  vault                Vault?        @relation(fields: [vaultId], references: [id])
  name                 String
  bank                 String
  type                 String // "checking", "savings", "investment", "credit_card", "other"
  balance              Float
  creditLimit          Float?
  logoUrl              String?
  visibleIn            String[]      @default([]) // Array of vaultIds
  allowFullAccess      Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  transactionsAsSource Transaction[] @relation("SourceAccount")
  transactionsAsDest   Transaction[] @relation("DestinationAccount")

  @@map("accounts")
}

model Goal {
  id           String            @id @default(cuid())
  ownerId      String // userId or vaultId
  ownerType    String // "user" or "vault"
  name         String
  targetAmount Float
  currentAmount Float            @default(0)
  emoji        String
  visibility   String // "private" or "shared"
  isFeatured   Boolean           @default(false)
  participants GoalParticipant[]
  transactions Transaction[]
  userId       String?
  user         User?             @relation(fields: [userId], references: [id])
  vaultId      String?
  vault        Vault?            @relation(fields: [vaultId], references: [id])
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@map("goals")
}

model GoalParticipant {
  id                    String  @id @default(cuid())
  goalId                String
  goal                  Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  userId                String
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                  String // "owner", "member"
  contributionContextId String? // e.g., an accountId or vaultId

  @@unique([goalId, userId])
  @@map("goal_participants")
}

model Transaction {
  id                   String    @id @default(cuid())
  ownerId              String // userId or vaultId
  ownerType            String // "user" or "vault"
  date                 DateTime
  description          String
  amount               Float
  type                 String // "income", "expense", "transfer"
  category             String
  paymentMethod        String?
  sourceAccountId      String?
  sourceAccount        Account?  @relation("SourceAccount", fields: [sourceAccountId], references: [id])
  destinationAccountId String?
  destinationAccount   Account?  @relation("DestinationAccount", fields: [destinationAccountId], references: [id])
  goalId               String?
  goal                 Goal?     @relation(fields: [goalId], references: [id])
  actorId              String?
  actor                User?     @relation("TransactionActor", fields: [actorId], references: [id])
  vaultId              String?
  vault                Vault?    @relation(fields: [vaultId], references: [id])
  isRecurring          Boolean   @default(false)
  isInstallment        Boolean   @default(false)
  installmentNumber    Int?
  totalInstallments    Int?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@map("transactions")
}

model Invitation {
  id         String   @id @default(cuid())
  type       String // "vault", "goal"
  targetId   String
  targetName String
  senderId   String
  sender     User     @relation("InvitationSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("InvitationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status     String   @default("pending") // "pending", "accepted", "declined"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("invitations")
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String // "goal_invite", "transaction_added", etc.
  text        String
  actorId     String?
  actorName   String?
  actorAvatar String?
  relatedId   String?
  link        String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notifications")
}

model SavedReport {
  id           String   @id @default(cuid())
  ownerId      String
  monthYear    String
  analysisHtml String
  createdAt    DateTime @default(now())

  @@unique([ownerId, monthYear])
  @@map("saved_reports")
}
