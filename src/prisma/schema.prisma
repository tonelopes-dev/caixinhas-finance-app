// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}


model User {
  id                 String    @id @default(cuid())
  name               String
  email              String    @unique
  password           String
  avatarUrl          String?
  subscriptionStatus String    @default("trial") // e.g., "trial", "active", "inactive"
  trialExpiresAt     DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  ownedVaults       Vault[]           @relation("Owner")
  vaults            VaultMember[]
  ownedAccounts     Account[]         @relation("Owner")
  transactions      Transaction[]     @relation("UserTransactions")
  actedOn           Transaction[]     @relation("ActorTransactions")
  ownedGoals        Goal[]            @relation("UserGoals")
  goalsParticipating GoalParticipant[]
  sentInvitations   Invitation[]      @relation("Sender")
  receivedInvitations Invitation[]    @relation("Receiver")
  notifications     Notification[]
  categories        Category[]
  savedReports      SavedReport[]
}

model Vault {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String?
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   User          @relation("Owner", fields: [ownerId], references: [id], onDelete: Cascade)
  members VaultMember[]
  accounts Account[]
  transactions Transaction[]
  goals     Goal[]

  @@index([ownerId])
}

model VaultMember {
  id      String @id @default(cuid())
  vaultId String
  userId  String
  role    String @default("member") // e.g., "owner", "admin", "member"

  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([vaultId, userId])
  @@index([userId])
}

model Account {
  id           String   @id @default(cuid())
  name         String
  bank         String
  type         String   // "checking", "savings", "investment", "credit_card", "other"
  balance      Float
  creditLimit  Float?
  logoUrl      String?
  scope        String   // "personal" ou "vault"
  ownerId      String
  vaultId      String?
  visibleIn    String[] @default([])

  owner              User         @relation("Owner", fields: [ownerId], references: [id], onDelete: Cascade)
  vault              Vault?       @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  sourceTransactions Transaction[] @relation("SourceAccount")
  destTransactions   Transaction[] @relation("DestinationAccount")

  @@index([ownerId])
  @@index([vaultId])
}

model Goal {
  id            String   @id @default(cuid())
  name          String
  targetAmount  Float
  currentAmount Float    @default(0)
  emoji         String
  visibility    String   @default("shared") // "private", "shared"
  isFeatured    Boolean  @default(false)
  userId        String?
  vaultId       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user         User?              @relation("UserGoals", fields: [userId], references: [id], onDelete: Cascade)
  vault        Vault?             @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  participants GoalParticipant[]
  transactions Transaction[]

  @@index([userId])
  @@index([vaultId])
}

model GoalParticipant {
  id     String @id @default(cuid())
  goalId String
  userId String
  role   String @default("member")

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([goalId, userId])
  @@index([userId])
}

model Transaction {
  id                 String   @id @default(cuid())
  date               DateTime
  description        String
  amount             Float
  type               String // "income", "expense", "transfer"
  category           String
  paymentMethod      String?
  isRecurring        Boolean  @default(false)
  isInstallment      Boolean  @default(false)
  installmentNumber  Int?
  totalInstallments  Int?
  actorId            String
  userId             String?
  vaultId            String?
  sourceAccountId    String?
  destinationAccountId String?
  goalId             String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  actor              User      @relation("ActorTransactions", fields: [actorId], references: [id])
  user               User?     @relation("UserTransactions", fields: [userId], references: [id], onDelete: Cascade)
  vault              Vault?    @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  sourceAccount      Account?  @relation("SourceAccount", fields: [sourceAccountId], references: [id], onDelete: SetNull)
  destinationAccount Account?  @relation("DestinationAccount", fields: [destinationAccountId], references: [id], onDelete: SetNull)
  goal               Goal?     @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([vaultId])
  @@index([sourceAccountId])
  @@index([destinationAccountId])
  @@index([goalId])
  @@index([date])
}

model Invitation {
  id         String   @id @default(cuid())
  type       String   // e.g., "vault", "goal"
  targetId   String   // ID of the vault or goal
  targetName String
  senderId   String
  receiverId String
  status     String   @default("pending") // "pending", "accepted", "declined"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sender   User @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([type, targetId, receiverId])
  @@index([receiverId])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  message     String
  isRead      Boolean  @default(false)
  link        String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Category {
  id      String @id @default(cuid())
  name    String
  ownerId String
  
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([name, ownerId])
  @@index([ownerId])
}

model SavedReport {
  id           String   @id @default(cuid())
  ownerId      String
  monthYear    String
  analysisHtml String
  createdAt    DateTime @default(now())

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([ownerId, monthYear])
  @@index([ownerId])
}
